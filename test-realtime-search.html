<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>实时IBKR搜索测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        .warning { background: #ff9800; color: white; }
        input {
            padding: 10px;
            width: 200px;
            margin-right: 10px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
        }
        .contract-item {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .stat-item {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 实时IBKR搜索测试</h1>
        
        <div class="info">
            <strong>测试说明：</strong> 测试真正的IBKR API搜索功能，包括secdef/search和contract/info。
        </div>
        
        <div class="mb-4">
            <input
                type="text"
                id="searchInput"
                placeholder="输入合约符号 (如: MES, MNQ)"
                value="MES"
            />
            <button onclick="testRealTimeSearch()">实时搜索</button>
            <button onclick="testDatabase()">测试数据库</button>
            <button onclick="clearResults()">清除结果</button>
        </div>

        <div class="mb-4">
            <button onclick="testSecdefSearch()">测试 secdef/search</button>
            <button onclick="testContractInfo()">测试 contract/info</button>
            <button onclick="testFullFlow()">测试完整流程</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        async function testRealTimeSearch() {
            const symbol = document.getElementById('searchInput').value.trim();
            if (!symbol) {
                showResult('请输入合约符号', 'error');
                return;
            }

            showResult(`开始实时搜索 ${symbol}...`, 'info');
            
            try {
                // 模拟调用实时搜索API
                const results = await simulateRealTimeSearch(symbol);
                if (results && results.length > 0) {
                    let html = `<div class="success">✅ 实时搜索成功！找到 ${results.length} 个合约:</div>`;
                    results.forEach(contract => {
                        html += `
                            <div class="contract-item">
                                <strong>${contract.symbol}</strong> - ${contract.description}<br>
                                合约ID: ${contract.conid} | 交易所: ${contract.exchange}<br>
                                公司: ${contract.companyName}<br>
                                最后更新: ${contract.lastUpdated}
                            </div>
                        `;
                    });
                    showResult(html, 'success');
                } else {
                    showResult(`❌ 未找到 ${symbol} 合约`, 'error');
                }
            } catch (error) {
                showResult(`❌ 实时搜索失败: ${error.message}`, 'error');
            }
        }

        async function simulateRealTimeSearch(symbol) {
            // 模拟实时搜索流程
            showResult('步骤1: 调用 secdef/search 获取基础合约...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            showResult('步骤2: 调用 contract/info 获取详细信息...', 'info');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            showResult('步骤3: 保存到数据库...', 'info');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 模拟搜索结果
            const results = {
                'MES': [
                    {
                        conid: '730283085',
                        symbol: 'MES',
                        description: 'Micro E-Mini S&P 500 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group',
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        conid: '711280067',
                        symbol: 'MES',
                        description: 'Micro E-Mini S&P 500 SEP25',
                        exchange: 'CME',
                        companyName: 'CME Group',
                        lastUpdated: new Date().toISOString()
                    }
                ],
                'MNQ': [
                    {
                        conid: '730283094',
                        symbol: 'MNQ',
                        description: 'Micro E-Mini Nasdaq-100 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group',
                        lastUpdated: new Date().toISOString()
                    }
                ]
            };
            
            const upperSymbol = symbol.toUpperCase();
            return results[upperSymbol] || [];
        }

        async function testSecdefSearch() {
            showResult('测试 secdef/search API...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/ibkr/iserver/secdef/search?symbol=MES&exchange=CME&currency=USD&secType=FUT');
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ secdef/search 成功\n返回数据: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`❌ secdef/search 失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ secdef/search 错误: ${error.message}`, 'error');
            }
        }

        async function testContractInfo() {
            showResult('测试 contract/info API...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/ibkr/iserver/contract/730283085/info');
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ contract/info 成功\n返回数据: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`❌ contract/info 失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`❌ contract/info 错误: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            showResult('开始测试完整搜索流程...', 'info');
            
            // 测试IBKR连接
            await testIBKRConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 测试secdef/search
            await testSecdefSearch();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 测试contract/info
            await testContractInfo();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 测试数据库
            await testDatabase();
        }

        async function testIBKRConnection() {
            try {
                const response = await fetch('http://localhost:3001/ibkr/iserver/auth/status');
                if (response.ok) {
                    const data = await response.json();
                    showResult(`✅ IBKR连接正常\n认证: ${data.authenticated}\n连接: ${data.connected}`, 'success');
                } else {
                    showResult(`❌ IBKR连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult(`❌ IBKR连接错误: ${error.message}`, 'error');
            }
        }

        async function testDatabase() {
            showResult('测试数据库功能...', 'info');
            
            // 模拟数据库统计
            const stats = {
                totalContracts: 15,
                configuredContracts: 3,
                searchHistoryCount: 5,
                lastUpdated: new Date().toISOString()
            };
            
            let html = `<div class="success">✅ 数据库功能正常</div>`;
            html += `<div class="stats">`;
            html += `<div class="stat-item"><strong>总合约数</strong><br>${stats.totalContracts}</div>`;
            html += `<div class="stat-item"><strong>已配置</strong><br>${stats.configuredContracts}</div>`;
            html += `<div class="stat-item"><strong>搜索历史</strong><br>${stats.searchHistoryCount}</div>`;
            html += `<div class="stat-item"><strong>最后更新</strong><br>${new Date(stats.lastUpdated).toLocaleString()}</div>`;
            html += `</div>`;
            
            showResult(html, 'success');
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // 页面加载时显示说明
        window.onload = function() {
            showResult('页面加载完成。\n\n测试步骤：\n1. 输入合约符号并点击"实时搜索"\n2. 测试各个API端点\n3. 查看数据库功能\n\n注意：这是模拟测试，实际功能需要IBKR Gateway支持', 'info');
        };
    </script>
</body>
</html> 