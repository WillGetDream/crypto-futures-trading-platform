<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åˆçº¦æœç´¢æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        .contract-item {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” åˆçº¦æœç´¢åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="info">
            <strong>è¯´æ˜ï¼š</strong> è¿™ä¸ªé¡µé¢æµ‹è¯•åˆçº¦æœç´¢åŠŸèƒ½ï¼ŒåŒ…æ‹¬IBKR APIå’Œå¤‡ç”¨æ•°æ®ã€‚
        </div>
        
        <div class="mb-4">
            <input
                type="text"
                id="searchInput"
                placeholder="è¾“å…¥åˆçº¦ç¬¦å· (å¦‚: MES, MNQ, ES)"
                style="padding: 10px; width: 200px; margin-right: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px;"
            />
            <button onclick="testSearch()">æœç´¢åˆçº¦</button>
        </div>

        <div class="mb-4">
            <button onclick="testPredefined()">æµ‹è¯•é¢„å®šä¹‰åˆçº¦</button>
            <button onclick="testIBKRAPI()">æµ‹è¯•IBKR API</button>
            <button onclick="testAll()">æµ‹è¯•æ‰€æœ‰åŠŸèƒ½</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        async function testSearch() {
            const symbol = document.getElementById('searchInput').value.trim();
            if (!symbol) {
                showResult('è¯·è¾“å…¥åˆçº¦ç¬¦å·', 'error');
                return;
            }

            showResult('æœç´¢ä¸­...', 'info');
            
            try {
                // æ¨¡æ‹Ÿè°ƒç”¨æœç´¢API
                const results = await simulateSearch(symbol);
                if (results && results.length > 0) {
                    let html = `<div class="success">âœ… æ‰¾åˆ° ${results.length} ä¸ªåˆçº¦:</div>`;
                    results.forEach(contract => {
                        html += `
                            <div class="contract-item">
                                <strong>${contract.symbol}</strong> - ${contract.description}<br>
                                åˆçº¦ID: ${contract.conid} | äº¤æ˜“æ‰€: ${contract.exchange}<br>
                                å…¬å¸: ${contract.companyName}
                            </div>
                        `;
                    });
                    showResult(html, 'success');
                } else {
                    showResult('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„åˆçº¦', 'error');
                }
            } catch (error) {
                showResult(`âŒ æœç´¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function simulateSearch(symbol) {
            // æ¨¡æ‹Ÿé¢„å®šä¹‰çš„åˆçº¦æ•°æ®
            const predefinedContracts = {
                'MES': [
                    {
                        conid: '730283085',
                        symbol: 'MES',
                        description: 'Micro E-Mini S&P 500 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    },
                    {
                        conid: '711280067',
                        symbol: 'MES',
                        description: 'Micro E-Mini S&P 500 SEP25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    }
                ],
                'MNQ': [
                    {
                        conid: '730283094',
                        symbol: 'MNQ',
                        description: 'Micro E-Mini Nasdaq-100 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    },
                    {
                        conid: '711280073',
                        symbol: 'MNQ',
                        description: 'Micro E-Mini Nasdaq-100 SEP25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    }
                ],
                'ES': [
                    {
                        conid: '495512563',
                        symbol: 'ES',
                        description: 'E-mini S&P 500 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    }
                ],
                'NQ': [
                    {
                        conid: '563947738',
                        symbol: 'NQ',
                        description: 'E-mini NASDAQ 100 DEC25',
                        exchange: 'CME',
                        companyName: 'CME Group'
                    }
                ]
            };

            // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const upperSymbol = symbol.toUpperCase();
            return predefinedContracts[upperSymbol] || [];
        }

        async function testPredefined() {
            showResult('æµ‹è¯•é¢„å®šä¹‰åˆçº¦æ•°æ®...', 'info');
            
            const symbols = ['MES', 'MNQ', 'ES', 'NQ'];
            let results = [];
            
            for (const symbol of symbols) {
                const contracts = await simulateSearch(symbol);
                results = results.concat(contracts);
            }
            
            if (results.length > 0) {
                let html = `<div class="success">âœ… é¢„å®šä¹‰åˆçº¦æµ‹è¯•æˆåŠŸï¼Œå…± ${results.length} ä¸ªåˆçº¦:</div>`;
                results.forEach(contract => {
                    html += `
                        <div class="contract-item">
                            <strong>${contract.symbol}</strong> - ${contract.description}
                        </div>
                    `;
                });
                showResult(html, 'success');
            } else {
                showResult('âŒ é¢„å®šä¹‰åˆçº¦æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        async function testIBKRAPI() {
            showResult('æµ‹è¯•IBKR APIè¿æ¥...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/ibkr/iserver/auth/status');
                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… IBKR APIè¿æ¥æˆåŠŸ\nè®¤è¯: ${data.authenticated}\nè¿æ¥: ${data.connected}`, 'success');
                } else {
                    showResult(`âŒ IBKR APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ IBKR APIè¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testAll() {
            showResult('å¼€å§‹å…¨é¢æµ‹è¯•...', 'info');
            
            // æµ‹è¯•IBKR API
            await testIBKRAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // æµ‹è¯•é¢„å®šä¹‰æ•°æ®
            await testPredefined();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // æµ‹è¯•æœç´¢åŠŸèƒ½
            document.getElementById('searchInput').value = 'MES';
            await testSearch();
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            showResult('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
</body>
</html> 